# التحديثات الجديدة - نظام سجل التدخين اليومي

## المشكلة التي تم حلها

تم إزالة سجل التدخين اليومي من مكانه الثابت في الداشبورد وتم استبداله بنافذة منبثقة تظهر بعد تسجيل الدخول مباشرة.

## التغييرات الرئيسية

### 1. نافذة منبثقة للأيام المفقودة (`MissingDaysPopup`)

- **الملف**: `app/components/MissingDaysPopup.tsx`
- **الوظيفة**: نافذة تفاعلية تظهر بعد تسجيل الدخول
- **المميزات**:
  - تسأل عن كل يوم مفقود على حدة
  - شريط تقدم يوضح المرحلة الحالية
  - إمكانية الرجوع للخلف
  - إمكانية تخطي الأيام المتبقية (يتم اعتبارها بدون تدخين)
  - حفظ تلقائي للبيانات في قاعدة البيانات

### 2. تحديث صفحة تسجيل الدخول

- **الملف**: `app/login/page.tsx`
- **التغييرات**:
  - إضافة منطق للتحقق من الأيام المفقودة بعد تسجيل الدخول
  - إظهار النافذة المنبثقة إذا وُجدت أيام مفقودة (أكثر من يوم واحد)
  - الانتقال المباشر للداشبورد إذا لم توجد أيام مفقودة

### 3. إزالة سجل التدخين من الداشبورد

- **الملف**: `app/dashboard/page.tsx`
- **التغييرات**:
  - إزالة مكون `DailyTracking` من الداشبورد
  - إضافة دالة `updateNetDaysForAchievementsAndHealth` لتحديث البيانات
  - تحديث `calculateActualDaysWithoutSmoking` لاستخدام البيانات الجديدة

### 4. نظام حساب جديد للأيام

#### للداشبورد:

- **المتغير**: `totalDaysWithoutSmoking`
- **الحساب**: إجمالي الأيام بدون تدخين (فقط الأيام التي لم يدخن فيها المستخدم)
- **الاستخدام**: عرض الإحصائيات في الداشبورد والمدخرات

#### للأوسمة والصحة:

- **المتغير**: `netDaysWithoutSmoking`
- **الحساب**: الأيام بدون تدخين - أيام التدخين
- **الاستخدام**: تحديد الأوسمة المكتسبة ومستوى الصحة
- **المثال**: إذا كان المستخدم لديه 10 أيام بدون تدخين و 3 أيام دخن فيها، فإن:
  - `totalDaysWithoutSmoking` = 10 (للداشبورد)
  - `netDaysWithoutSmoking` = 10 - 3 = 7 (للأوسمة والصحة)

### 5. تحديث صفحات الأوسمة والصحة

- **الملفات**: `app/achievements/page.tsx` و `app/health/page.tsx`
- **التغييرات**:
  - استخدام `netDaysWithoutSmoking` بدلاً من `totalDaysWithoutSmoking`
  - قراءة البيانات من localStorage المحدث

## قاعدة البيانات الجديدة

### البيانات المضافة للمستخدم:

```javascript
{
  // البيانات الموجودة سابقاً...
  dailyRecords: {
    "2025-01-01": {
      date: "2025-01-01",
      smoked: false,
      recordedAt: "2025-01-01T10:00:00.000Z",
      recordedManually: true
    }
    // ...المزيد من السجلات
  },
  totalDaysWithoutSmoking: 10,    // للداشبورد والمدخرات
  netDaysWithoutSmoking: 7,       // للأوسمة والصحة
  totalDaysSmoked: 3,             // إجمالي أيام التدخين
  totalSavings: 2000              // المدخرات المحسوبة
}
```

## تدفق العمل الجديد

1. **تسجيل الدخول**: المستخدم يدخل بياناته
2. **التحقق من الأيام المفقودة**: النظام يتحقق من وجود أيام غير مسجلة
3. **النافذة المنبثقة**: إذا وُجدت أيام مفقودة، تظهر نافذة تسأل عن كل يوم
4. **الحفظ التلقائي**: البيانات تُحفظ في قاعدة البيانات و localStorage
5. **تحديث الحسابات**:
   - `totalDaysWithoutSmoking` للداشبورد
   - `netDaysWithoutSmoking` للأوسمة والصحة
6. **الانتقال للداشبورد**: بعد الانتهاء، ينتقل المستخدم للداشبورد

## المميزات الجديدة

### 1. سهولة الاستخدام

- لا حاجة للبحث عن سجل التدخين في الموقع
- يظهر تلقائياً عند الحاجة فقط

### 2. دقة البيانات

- حساب منفصل للداشبورد والأوسمة/الصحة
- الأوسمة تأخذ في الاعتبار أيام التدخين (تطرحها من المجموع)

### 3. تجربة مستخدم محسنة

- واجهة تفاعلية وجذابة للنافذة المنبثقة
- شريط تقدم واضح
- إمكانية التراجع والتخطي

### 4. حفظ البيانات

- حفظ تلقائي في قاعدة البيانات
- نسخ احتياطية في localStorage
- استرجاع البيانات عند الحاجة

## ملفات localStorage الجديدة

```javascript
// للداشبورد
localStorage.setItem("anfask-totalDaysWithoutSmoking", "10");

// للأوسمة والصحة
localStorage.setItem("anfask-netDaysWithoutSmoking", "7");

// البيانات الحالية (تبقى كما هي)
localStorage.setItem("anfask-actualDaysWithoutSmoking", "10");
```

## ملاحظات مهمة

1. **التوافق مع النظام السابق**: النظام يدعم البيانات القديمة ويحدثها تدريجياً
2. **الأداء**: استخدام localStorage يقلل من استعلامات قاعدة البيانات
3. **المرونة**: يمكن للمستخدم تخطي النافذة إذا لم يرد استكمال البيانات
4. **الدقة**: حساب منفصل يضمن دقة البيانات في كل قسم

## اختبار التطبيق

تم بناء التطبيق بنجاح بدون أخطاء:

- ✅ جميع الـ TypeScript types صحيحة
- ✅ لا توجد أخطاء في البناء
- ✅ جميع المكونات تعمل بشكل صحيح
